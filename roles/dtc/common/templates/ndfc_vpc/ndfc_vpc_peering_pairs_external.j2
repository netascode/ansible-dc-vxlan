{% from 'macros/convert_ranges.j2' import convert_ranges as convert_ranges %}

---
# This NDFC vPC Peering config data structure for vPC pairs in External Fabrics is auto-generated
# DO NOT EDIT MANUALLY
#
{% if data_model_extended.vxlan.topology.vpc_peers is defined and data_model_extended.vxlan.topology.vpc_peers is not none %}
{% for vpc_peers_pair in data_model_extended.vxlan.topology.vpc_peers %}
- peerOneId: {{ vpc_peers_pair.peer1_mgmt_ip_address }}
  peerTwoId: {{ vpc_peers_pair.peer2_mgmt_ip_address }}
  templateName: "vpc_pair"
  profile:
    DOMAIN_ID: {{ vpc_peers_pair.domain_id }}
    FABRIC_NAME: {{ data_model_extended.vxlan.fabric.name }}
    KEEP_ALIVE_HOLD_TIMEOUT: {{ vpc_peers_pair.keepalive_hold_time | default(defaults.vxlan.topology.vpc_peers.keepalive_hold_time) }}
    KEEP_ALIVE_VRF: {{ vpc_peers_pair.keepalive_vrf }}
    PEER1_DOMAIN_CONF: |2-
      {{ vpc_peers_pair.peer1_domain_conf | default('') | indent(6, false) }}
    PEER1_KEEP_ALIVE_LOCAL_IP: {{ vpc_peers_pair.peer1_keepalive_ipv4 }}
    PEER2_DOMAIN_CONF: |2-
      {{ vpc_peers_pair.peer2_domain_conf | default('') | indent(6, false)}}
    PEER2_KEEP_ALIVE_LOCAL_IP: {{ vpc_peers_pair.peer2_keepalive_ipv4 }}
{% set peer1_switch = data_model_extended.vxlan.topology.switches | selectattr('name', 'equalto', vpc_peers_pair.peer1) | first %}
{% set peer2_switch = data_model_extended.vxlan.topology.switches | selectattr('name', 'equalto', vpc_peers_pair.peer2) | first %}
{% if peer1_switch.interfaces is defined %}
{% set peer1_vpc_interface = peer1_switch.interfaces | selectattr('name', 'match', '^(port-channel|po)') | selectattr('mode', 'equalto', 'vpc_peer_link') | first | default({}) %}
{% endif %}
{% if peer2_switch.interfaces is defined %}
{% set peer2_vpc_interface = peer2_switch.interfaces | selectattr('name', 'match', '^(port-channel|po)') | selectattr('mode', 'equalto', 'vpc_peer_link') | first | default({}) %}
{% endif %}
{% if peer1_vpc_interface.name is defined %}
    PEER1_PO_CONF: |2-
      {{ peer1_vpc_interface.freeform_config | default('') | indent(6, false) }}
    PEER2_PO_CONF: |2-
      {{ peer2_vpc_interface.freeform_config | default('') | indent(6, false) }}
    PC_MODE: {{ peer1_vpc_interface.pc_mode | default(defaults.vxlan.topology.switches.interfaces.topology_switch_trunk_po_interface.pc_mode)}}
    PEER1_PO_DESC: "{{ peer1_vpc_interface.description | default('') }}"
    PEER2_PO_DESC: "{{ peer2_vpc_interface.description | default('') }}"
    PEER1_PCID: {{ peer1_vpc_interface.name | default('') | regex_replace('^(port-channel|po)', '') | default('') }}
    PEER2_PCID: {{ peer2_vpc_interface.name | default('') | regex_replace('^(port-channel|po)', '') | default('') }}
    PEER1_MEMBER_INTERFACES: "{{ peer1_vpc_interface.members | default([]) | join(',') }}"
    PEER2_MEMBER_INTERFACES: "{{ peer2_vpc_interface.members | default([]) | join(',') }}"
    ALLOWED_VLANS: "{{ convert_ranges(peer1_vpc_interface.trunk_allowed_vlans, defaults.vxlan.topology.switches.interfaces.topology_switch_trunk_po_interface.trunk_allowed_vlans)  | trim }}"
    ADMIN_STATE: {{ peer1_vpc_interface.enabled | default(defaults.vxlan.topology.switches.interfaces.topology_switch_trunk_po_interface.enabled)}}
{% endif %}
{% endfor %}
{% endif %}
