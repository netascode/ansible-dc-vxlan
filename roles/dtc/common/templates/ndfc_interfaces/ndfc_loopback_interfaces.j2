---
# This NDFC loopback interface data structure is auto-generated
# DO NOT EDIT MANUALLY
#
{% set is_manual_allocation = false %}
{% set skip = false %}
{% if data_model_extended.vxlan.underlay is defined %}
{% set is_manual_allocation = data_model_extended.vxlan.underlay.general.manual_underlay_allocation | default(defaults.vxlan.underlay.general.manual_underlay_allocation) %}
{% set routing_lo_id =  data_model_extended.vxlan.underlay.general.underlay_routing_loopback_id %}
{% set vtep_lo_id =  data_model_extended.vxlan.underlay.general.underlay_vtep_loopback_id %}
{% endif %}

{% for switch in data_model_extended.vxlan.topology.switches %}
{% if switch.interfaces is defined %}
{% for interface in switch.interfaces %}
{% if interface.mode is defined and interface.mode in ['loopback', 'mpls_loopback', 'fabric_loopback'] %}
{% set intf_lower = interface.name.lower() %}
{# Exclude Loopback when use as Routing / VTEP Loopback with manual_underlay_allocation for VXLAN_EVPN #}
{% if is_manual_allocation is true %}
{% if (intf_lower == "loopback" ~ vtep_lo_id or intf_lower == "lo" ~ vtep_lo_id or intf_lower == "loopback" ~ routing_lo_id or intf_lower == "lo" ~ routing_lo_id) %}
{% set skip = true %}
{% endif %}
{% endif %}
{% if skip is false %}
- name: {{ interface.name }}
  type: lo
  switch:
{% if switch.management.management_ipv4_address is defined %}
    - {{ switch.management.management_ipv4_address}}
{% elif (switch.management.management_ipv4_address is not defined) and (switch.management.management_ipv6_address is defined)  %}
    - {{ switch.management.management_ipv6_address}}
{% endif %}
  deploy: false
  profile:
{% if interface.mode == 'loopback' %}
    mode: lo
{% elif interface.mode == 'mpls_loopback' %}
    mode: mpls
{% elif interface.mode == 'fabric_loopback' %}
    mode: fabric
{% endif %}
    int_vrf: {{ interface.vrf | default(omit) }}
    description: "{{ interface.description | default(defaults.vxlan.topology.switches.interfaces.topology_switch_loopback_interface.description) }}"
    admin_state: {{ interface.enabled | default(defaults.vxlan.topology.switches.interfaces.topology_switch_loopback_interface.enabled) }}
    ipv4_addr: {{ interface.ipv4_address | default(omit) }}
    ipv6_addr: {{ interface.ipv6_address | default(omit) }}
    route_tag: {{ interface.ipv4_route_tag | default(omit) }}
{# ------------------------------------------------------ #}
{# Todo: Need special handling for secondary ipv4 address and route_tag #}
{#       Module only supports one secondary and tag and no ipv6 support #}
{#       Also need to add freeform commands to the model? #}
{# ------------------------------------------------------ #}
    secondary_ipv4_addr: {{ interface.secondary_ipv4_addresses[0].ip_address | default(omit) }}
    cmds: |2-
      {{ interface.freeform_config | default('') | indent(6) }}
{% endif %}
{% endif %}
{% endfor %}
{% endif %}
{% endfor %}
