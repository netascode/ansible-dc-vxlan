---
- name: Initialize tor pairing change flag
  ansible.builtin.set_fact:
    changes_detected_tor_pairing: false
  delegate_to: localhost

- name: Set tor pairing file name
  ansible.builtin.set_fact:
    file_name: "ndfc_tor_pairing.yml"
  delegate_to: localhost

- name: Stat previous tor pairing file if it exists
  ansible.builtin.stat:
    path: "{{ path_name }}{{ file_name }}"
  register: tor_pairing_previous
  delegate_to: localhost

- name: Backup previous tor pairing file if it exists
  ansible.builtin.copy:
    src: "{{ path_name }}{{ file_name }}"
    dest: "{{ path_name }}{{ file_name }}.old"
    mode: preserve
  when: tor_pairing_previous.stat.exists
  delegate_to: localhost

- name: Delete previous tor pairing file if it exists
  ansible.builtin.file:
    state: absent
    path: "{{ path_name }}{{ file_name }}"
  when: tor_pairing_previous.stat.exists
  delegate_to: localhost

- name: Build ToR pairing payloads
  ansible.builtin.template:
    src: ndfc_tor_pairing.j2
    dest: "{{ path_name }}{{ file_name }}"
    mode: '0644'
  delegate_to: localhost

- name: Initialize ToR pairing facts
  ansible.builtin.set_fact:
    tor_pairing: []
    tor_pairing_removed: []
    tor_pairing_previous_list: []
    tor_pairing_current_list: []
  delegate_to: localhost

- name: Load previous ToR pairing payloads
  ansible.builtin.set_fact:
    tor_pairing_previous_list: "{{ lookup('file', path_name + file_name + '.old') | from_yaml | default([], true) }}"
  delegate_to: localhost
  when: tor_pairing_previous.stat.exists

# ============================================================
# Brownfield Support: Query NDFC for existing ToR pairings
# when artifact file is missing
# ============================================================

- name: Get list of leaf switches for ToR pairing discovery
  ansible.builtin.set_fact:
    leaf_switches_for_query: >-
      {{ MD_Extended.vxlan.topology.switches
         | selectattr('role', 'equalto', 'leaf')
         | list }}
  delegate_to: localhost
  when: not tor_pairing_previous.stat.exists

- name: Query NDFC from first leaf switch for ToR pairing discovery
  cisco.dcnm.dcnm_rest:
    method: GET
    path: "/appcenter/cisco/ndfc/api/v1/lan-fabric/rest/control/tor/fabrics/{{ MD_Extended.vxlan.fabric.name }}/switches/{{ leaf_switches_for_query[0].serial_number }}"
  register: ndfc_tor_discovery
  failed_when: false
  when:
    - not tor_pairing_previous.stat.exists
    - leaf_switches_for_query is defined
    - leaf_switches_for_query | length > 0

- name: Verify NDFC ToR discovery query succeeded
  ansible.builtin.assert:
    that:
      - ndfc_tor_discovery is defined
      - not (ndfc_tor_discovery.failed | default(false))
    fail_msg: "Failed to query ToR pairings from NDFC. Cannot proceed with brownfield removal detection."
    success_msg: "Successfully queried NDFC for existing ToR pairings"
  delegate_to: localhost
  when:
    - not tor_pairing_previous.stat.exists
    - leaf_switches_for_query is defined
    - leaf_switches_for_query | length > 0

- name: Initialize NDFC discovered pairings list
  ansible.builtin.set_fact:
    ndfc_discovered_pairings: []
  delegate_to: localhost
  when: not tor_pairing_previous.stat.exists

- name: Extract existing ToR pairings from NDFC response
  ansible.builtin.set_fact:
    ndfc_discovered_pairings: >-
      {{ ndfc_discovered_pairings + [
        {
          'pairing_id': (tor_pair.torName | replace('~', '-')),
          'scenario': (
            'vpc_to_vpc' if (tor_pair.torPeerSN is not none and ',' in (tor_pair.leafSNs | default('')))
            else 'vpc_to_standalone' if (',' in (tor_pair.leafSNs | default('')) and tor_pair.torPeerSN is none)
            else 'standalone_to_standalone'
          ),
          'payload': {
            'leafSN1': (tor_pair.leafSNs.split(',')[0] if tor_pair.leafSNs and ',' in tor_pair.leafSNs else tor_pair.leafSNs | default('')),
            'leafSN2': (tor_pair.leafSNs.split(',')[1] if tor_pair.leafSNs and ',' in tor_pair.leafSNs and tor_pair.leafSNs.split(',') | length > 1 else ''),
            'torSN1': (tor_pair.torSN.split(',')[0] if ',' in (tor_pair.torSN | default('')) else tor_pair.torSN | default('')),
            'torSN2': (tor_pair.torSN.split(',')[1] if ',' in (tor_pair.torSN | default('')) and tor_pair.torSN.split(',') | length > 1 else '')
          }
        }
      ] }}
  loop: "{{ ndfc_tor_discovery.response.DATA.torPairs | default([]) | selectattr('remarks', 'search', 'Already paired') }}"
  loop_control:
    loop_var: tor_pair
    label: "{{ tor_pair.torName }} - {{ tor_pair.remarks }}"
  delegate_to: localhost
  when:
    - not tor_pairing_previous.stat.exists
    - ndfc_tor_discovery is defined
    - ndfc_tor_discovery.response is defined
    - ndfc_tor_discovery.response.DATA is defined
    - ndfc_tor_discovery.response.DATA.torPairs is defined

- name: Cache NDFC discovered pairings for future reference
  ansible.builtin.copy:
    content: "{{ ndfc_discovered_pairings | to_nice_yaml }}"
    dest: "{{ path_name }}ndfc_tor_pairing_discovered.yml"
    mode: '0644'
  delegate_to: localhost
  when:
    - not tor_pairing_previous.stat.exists
    - ndfc_discovered_pairings is defined
    - ndfc_discovered_pairings | length > 0

- name: Use NDFC discovered pairings as previous state (brownfield mode)
  ansible.builtin.set_fact:
    tor_pairing_previous_list: "{{ ndfc_discovered_pairings }}"
  delegate_to: localhost
  when:
    - not tor_pairing_previous.stat.exists
    - ndfc_discovered_pairings is defined
    - ndfc_discovered_pairings | length > 0

- name: Debug ToR pairing brownfield discovery
  ansible.builtin.debug:
    msg:
      - "==================== ToR Pairing Discovery ===================="
      - "Source: {{ '.old artifact file' if tor_pairing_previous.stat.exists else 'NDFC API query (brownfield)' }}"
      - "Leaf switches available: {{ leaf_switches_for_query | default([]) | length }}"
      - "NDFC discovered pairings: {{ ndfc_discovered_pairings | default([]) | length }}"
      - "Previous list count: {{ tor_pairing_previous_list | length }}"
      - "Discovered pairing IDs: {{ ndfc_discovered_pairings | default([]) | map(attribute='pairing_id') | list }}"
      - "=============================================================="
  delegate_to: localhost
  when:
    - not tor_pairing_previous.stat.exists
    - ndfc_discovered_pairings is defined

- name: Load ToR pairing payloads
  ansible.builtin.set_fact:
    tor_pairing_current_list: "{{ lookup('file', path_name + file_name) | from_yaml | default([], true) }}"
  delegate_to: localhost
  when: (lookup('file', path_name + file_name) | length) > 0

- name: Publish current ToR pairing list
  ansible.builtin.set_fact:
    tor_pairing: "{{ tor_pairing_current_list }}"
  delegate_to: localhost

- name: Run ToR pairing diff analysis (Python filter - O(n+m) performance)
  ansible.builtin.set_fact:
    tor_pairing_diff_result: "{{ tor_pairing_current_list | cisco.nac_dc_vxlan.tor_pairing_diff(tor_pairing_previous_list) }}"
  delegate_to: localhost
  when:
    - tor_pairing_previous_list | length > 0

- name: Extract removed pairings
  ansible.builtin.set_fact:
    tor_pairing_removed: "{{ tor_pairing_diff_result.removed | default([]) }}"
  delegate_to: localhost
  when:
    - tor_pairing_previous_list | length > 0
    - tor_pairing_diff_result is defined

- name: Initialize removed ToR pairings list (no previous state)
  ansible.builtin.set_fact:
    tor_pairing_removed: []
  delegate_to: localhost
  when:
    - tor_pairing_previous_list | length == 0

- name: Debug ToR pairing removal results
  ansible.builtin.debug:
    msg:
      - "==================== ToR Pairing Removal Analysis ===================="
      - "Previous pairings count: {{ tor_pairing_diff_result.stats.previous_count | default(tor_pairing_previous_list | length) }}"
      - "Current pairings count: {{ tor_pairing_diff_result.stats.current_count | default(tor_pairing_current_list | length) }}"
      - "Pairings to remove: {{ tor_pairing_diff_result.stats.removed_count | default(tor_pairing_removed | length) }}"
      - "Previous pairing IDs: {{ tor_pairing_diff_result.stats.previous_ids | default(tor_pairing_previous_list | map(attribute='pairing_id') | list) }}"
      - "Current pairing IDs: {{ tor_pairing_diff_result.stats.current_ids | default(tor_pairing_current_list | map(attribute='pairing_id') | list) }}"
      - "Removed pairing IDs: {{ tor_pairing_diff_result.stats.removed_ids | default(tor_pairing_removed | map(attribute='pairing_id') | list) }}"
      - "====================================================================="
  delegate_to: localhost
  when:
    - tor_pairing_previous_list | length > 0

- name: Diff ToR pairing payload file
  cisco.nac_dc_vxlan.dtc.diff_model_changes:
    file_name_previous: "{{ path_name }}{{ file_name }}.old"
    file_name_current: "{{ path_name }}{{ file_name }}"
  register: tor_pairing_diff
  delegate_to: localhost

- name: Flag ToR pairing changes when detected
  ansible.builtin.set_fact:
    changes_detected_tor_pairing: true
  when:
    - tor_pairing_diff.file_data_changed
    - check_roles['save_previous']
  delegate_to: localhost

- name: Flag ToR pairing removal when differences identified
  ansible.builtin.set_fact:
    changes_detected_tor_pairing: true
  when:
    - tor_pairing_removed | length > 0
  delegate_to: localhost
